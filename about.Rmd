---
title: "Analysis"
output: html_document
---
```{r, include=FALSE}
library(tidyverse)
library(dplyr)
library(fiftystater)
library(RColorBrewer)
library(zipcode)
data("fifty_states")
data("zipcode")
states_map <- map_data("state")
```
```{r merged data, echo=FALSE}
dat_merge <- readRDS("~/Desktop/BST 260/BST-260-Final-Project/dat_merge.rds")
phys <- readRDS("~/Desktop/BST 260/BST-260-Final-Project/phys.rds")

state_name <- c(state.name,"District Of Columbia")
states <- data.frame(state_name = state_name, state_abb = c(state.abb, "DC"))
```


### Vendors

Of the 265 vendors used by practitioners in our dataset, we found that 58.5% of the products used were from the top 10 most popular vendors. 

```{r, echo=FALSE, message=FALSE}
top10 <- dat_merge %>% 
  filter(!is.na(Vendor_Name)) %>% 
  group_by(Vendor_Name) %>% 
  summarize(num = n()) %>% 
  arrange(desc(num)) %>% top_n(10)

vendors <- as.vector(top10$Vendor_Name)

dat_merge %>% filter(Vendor_Name %in% vendors) %>% 
  group_by(Vendor_Name) %>% 
  summarise(num = n()) %>% 
  ggplot(aes(x = reorder(Vendor_Name, num), y = num)) + 
    geom_bar(stat='identity') + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("") +
    ylab("Number of Products Used") +
    ggtitle("Most Popular Vendors")
```


```{r, echo=FALSE}
pct_popvendors <- dat_merge %>% 
  group_by(Business_State_Territory) %>% 
  summarize(num = n(), 
            total_v = sum(Vendor_Name %in% vendors),
            opp = num - total_v) %>% 
  mutate(p_vend = total_v/num, u_vend = opp/num)

pct_popvendors %>% 
  ggplot() +
  geom_map(aes(map_id = id), data = fifty_states, map = fifty_states, color="grey50", fill="grey90") +
  geom_map(aes(map_id = tolower(Business_State_Territory), fill = p_vend), map = fifty_states, color="grey50") +
  coord_map() +
  scale_fill_gradientn(colors = brewer.pal(6, "Reds")) +
  expand_limits(x=states_map$long, y=states_map$lat) +
  theme_bw() +
  theme(axis.text = element_blank(), 
        axis.line = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(), 
        panel.grid = element_blank(), 
        axis.title = element_blank(),
        legend.position = "right",
        legend.title = element_blank()) +
  ggtitle("Usage of Top 10 Vendors")
```

We can see that the most popular vendors are used very popularly in Minnesota, but not in New York, Tennessee, Rhode Island, and Nevada.


Interestingly, there tend to be younger (more recently trained) practitioners in Minnesota who use EHR compared to the rest of the United States.
```{r, echo=FALSE}
age <- dat_merge %>% filter(!is.na(Graduation.year)) %>% group_by(Business_State_Territory) %>% summarize(yrsgrad = mean(2016 - Graduation.year))

age %>% 
  ggplot() +
  geom_map(aes(map_id = id), data = fifty_states, map = fifty_states, color="grey50", fill="grey90") +
  geom_map(aes(map_id = tolower(Business_State_Territory), fill = yrsgrad), map = fifty_states, color="grey50") +
  coord_map() +
  scale_fill_gradientn(colors = brewer.pal(6, "Reds")) +
  expand_limits(x=states_map$long, y=states_map$lat) +
  theme_bw() +
  theme(axis.text = element_blank(), 
        axis.line = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(), 
        panel.grid = element_blank(), 
        axis.title = element_blank(),
        legend.position = "right",
        legend.title = element_blank()) +
  ggtitle("Years Since Graduation")
```

Taking a closer look at the graduation year data in Minnesota, there was no clear pattern where there were more younger or older physicians. We could, however, tell that most of the physicians reported in this incentive program were based near Minneapolis.
```{r, echo = FALSE}
mn <- subset(states_map, region %in% c("minnesota"))

zip_mapdata <- dat_merge %>% 
  filter(!is.na(Graduation.year) & Business_State_Territory == "Minnesota") %>% 
  group_by(ZIP) %>% 
  summarize(yrsgrad = mean(2016 - Graduation.year)) %>% 
  left_join(zipcode, by = c("ZIP" = "zip"))

zip_mapdata %>% 
  ggplot() +
  geom_polygon(data=states_map, aes(x=long, y=lat, group = group),colour="grey50", fill="white") +
  geom_point(aes(x=longitude, y=latitude, color = yrsgrad),size=2,alpha=.5) +
  coord_fixed(xlim = c(-88, -98),  ylim = c(42, 50), ratio = 1.5) +
  theme_void() +
  theme(legend.title = element_blank())
```


** add product setting graphs? **

### The Physician-Level Model

#### To explore physician-level data, we used two methods to find associations.

Because we had many categorical variables with a large number of levels, we used association rule learning to explore the relationship between our variables of interest. From this method, we found that the following factors had the most meaningful associations:

* Medical School attended
* Primary Specialty
* Gender

However, we decided not to include medical school and primary specialty in our final model because medical school and primary specialty are highly correlated (think specialty-specific school such as chiropractic schools) and there were too many categorical levels of these variables to gain valuable insights regarding correlation.

```{r phys only data, eval=FALSE}
dat <- readRDS("~/Desktop/BST 260/BST-260-Final-Project-Site/EPs.rds")

EPs <- dat %>% filter(st %in% c(state.abb, "DC") & hosp_afl_1 == '') %>% 
  filter(gndr %in% c("F", "M") & !is.na(grd_yr)) %>% 
  mutate(yrs_grd = 2016 - as.integer(grd_yr),
         cred = case_when(cred == '' ~ 'NA',
                          TRUE ~ as.character(cred)),
         cred = as.factor(cred),
         ehr = case_when(ehr == 'Y' ~ 1,
                         ehr == '' ~ 0),
         ehr = as.factor(ehr)) %>% 
  select(-hosp_afl_1, -hosp_afl_lbn_1, -frst_nm) %>% 
  arrange(desc(ehr)) %>% 
  distinct(npi, .keep_all = TRUE)
```


```{r, eval=FALSE}
#physurl <- "https://raw.githubusercontent.com/euniceyeh/EHR-Project/blob/master/data/EPs.rds"
#download.file(physurl, "EPs.rds", method = 'curl')
#EPs <- readRDS("EPs.rds")
```

Using other exploratory methods such as plots and correlation matrices, we eliminated other variables that could be used to study the effects on EHR usage. We decided to study the effect of gender and years since graduation on EHR adoption among physicians, since there was adequate data on these variables and they were evenly distributed among the two outcome groups (use EHR/don't use EHR). 

#### Our physician-level model looked at the effect of physician gender and years since graduation on adoption of electronic health records.

Using logistic regression, we found that physician gender and years since graduation have statistically significant effects on the use of EHR among practitioners in the incentive program. The results of our model are presented and summarized below.

 | Odds Ratio | Confidence Interval (lower) | Confidence Interval (upper)
------------- | ------------- | -------------
Intercept | 0.0410 | 0.0399 | 0.0421
Gender (Male) | 2.0266 | 1.9732 | 2.0815
Years Since Graduation | 1.0172 | 1.0163 | 1.01819
Locations | 1.0024 | 0.9978 | 1.0060


* Holding years since graduation and locations at a fixed value, the odds of adopting EHR for males is 2.0266 the odds of adopting EHR for females (102.6% higher odds).
* Holding gender (male) and locations at a fixed value, the odds of adopting EHR has a 1.7% increase for each additional year since graduation.

** check difference in values if remove locations**

### The Hospital-Level Model



* size of hospital influences all other hospital variables, so it is a confounder
* female proportion has the strongest correlation to years since graduation?
* 2 most strongly correlated variables = # phys and gross patient rev?
* stratifying by gross patient revenue in GLM, the only significant = # phys



